options:
  logging: CLOUD_LOGGING_ONLY

steps:
# 0) Grab cluster creds (writes kubeconfig to /builder/home/.kube/config, which persists across steps)
- id: get-credentials
  name: gcr.io/cloud-builders/gcloud
  entrypoint: bash
  args:
    - -ceu
    - |
      gcloud container clusters get-credentials vikunja-autopilot \
        --region europe-west4 \
        --project vikunja-case

# 1) Namespace prepared and Helm-adoptable
- id: prepare-namespace
  name: gcr.io/cloud-builders/gcloud
  env:
    - KUBECONFIG=/builder/home/.kube/config
  entrypoint: bash
  args:
    - -ceu
    - |
      kubectl get ns vikunja >/dev/null 2>&1 || kubectl create ns vikunja
      kubectl label ns vikunja app.kubernetes.io/managed-by=Helm --overwrite
      kubectl annotate ns vikunja meta.helm.sh/release-name=vikunja meta.helm.sh/release-namespace=vikunja --overwrite

# 2) Secret from Secret Manager (no custom substitutions)
- id: create-secrets
  name: gcr.io/cloud-builders/gcloud
  env:
    - KUBECONFIG=/builder/home/.kube/config
  entrypoint: bash
  args:
    - -ceu
    - |
      kubectl -n vikunja create secret generic vikunja-db-secret \
        --from-literal=postgresql-password="$(gcloud secrets versions access latest --secret=vikunja-db-password)" \
        --dry-run=client -o yaml | kubectl apply -f -

# 3) Helm deploy using the Helm builder (pin version!)
- id: helm-deploy
  name: gcr.io/cloud-builders/helm:3.14.4
  env:
    - KUBECONFIG=/builder/home/.kube/config
  entrypoint: bash
  args:
    - -ceu
    - |
      helm upgrade --install vikunja ./helm/vikunja \
        --namespace vikunja --create-namespace \
        --wait --timeout 10m
